# Glops说明文档

## 项目说明

本组汇编小组作业实现项目为本地两人对战的消消乐游戏，玩法与常见消消乐游戏类似，双方轮流进行消除，先得到一定分数的玩家（在游戏中显示为扣除对方玩家更多的一方）获胜。

## 开发环境

* 操作系统：Windows 10 x64

* IDE:Visual Studio 2017 Professional
* 语言：汇编（开发环境：Masm）

## 实现原理

### 绘图

* 游戏元素绘制：Windows GDI绘图

### 游戏状态处理

通过更改页面变量的值来更改游戏状态，所有的游戏状态包括：开始、游戏中、游戏结束三种。

### 消息处理

通过在程序打开时设置循环产生的WM_Timer事件来实现频率刷新

### 游戏元素设计

* 棋子：定义结棋子构体，记录棋子的颜色，移动前位置、棋子类型（被删除棋子，普通棋子，炸弹棋子）

* 棋盘：由9*9共81个棋子构成的数组，可通过写好的set/getPiece、set/getNearByPiece的函数进行二维索引的访问。
* 玩家：定义玩家结构体，记录玩家血量，有一方归零则游戏结束。

### 交互处理

* 在频率刷新的更新函数中，根据游戏状态的不同，调用不同的交互处理函数，本游戏交互仅涉及鼠标左键的按下事件。
* 游戏内交互实现方式：
  * 通过点击坐标减去棋盘左上角的坐标，获取棋盘上的相对坐标（如果点击位置在棋盘内），经取模运算得点击的棋子；
  * 记录本次与上次（如果存在）点击的点击棋子位置，通过判断两次点击的棋子位置是执行交换操作还是更改选中棋子

### 棋子消除与生成

* #### 消除判定（单次）

  * 横向：从当前棋子出发，向左和向右分别查找连续的同色（当前棋子色）棋子的数量，相加，若大于等于3，且其中没有炸弹棋子，则执行单次消除操作，即在连续同色棋子的中央生成一个该颜色的炸弹棋子，消除所有其他相邻同色棋子，两侧的棋子向炸弹棋子靠拢（数组元素移位），在移位过程中更改棋子结构体中“上一次位置”属性，方便动画处理。

  * 纵向：与横向类似。
  * 炸弹：若连续的棋子大于等于3，且出现了炸弹棋子，则消除连续的棋子，并且清除炸弹棋子周围8个棋子，爆炸函数采取递归式实现，在周围8个棋子如果存在新的炸弹，则同样消除其周围8个棋子，递归边界为周围的棋子没有炸弹。

* #### 棋子生成

  * 判断局面是否已经存在解：为了使玩家获得更良好的体验，生成棋子时会进行全局的棋盘检测，以避免在生成棋子后全局无解而游戏强制结束的情况发生，棋盘检测会对棋子数组遍历三次，分别检测单个棋子与四个角落棋子的颜色，两个同色相邻棋子（横向，纵向）周围四枚棋子的颜色，然后返回是否有解得状态量。
  * 生成棋子：首先调用判断全局是否存在解的函数来确定生成棋子的策略，若已经存在解，则在每个空位生成棋子时随机指定颜色即可，若全局不存在解，则对空位棋子的位置与周围环境进行判断，若可以指定一种颜色使得全局有解，则指定新棋子为这种颜色，并更改全局是否有解的状态变量为有解，否则随机生成该棋子颜色并在下一个空位处进行相同判断。

* #### 连续消除

  由于需要在连续消除的过程中穿插消除、爆炸的动画效果，所以不能在一帧的运算过程中计算完所有的迭代消除，因此我们借用频率刷新的优势，采用循环判定的方式完成连续消除的步骤分割，每次刷新的更新函数内容如下：

  * 查询动画标记量，判断当前是否处于动画播放状（Anima是否大于等于45）态，若处于动画状态，则直接结束过程，不做数据处理

  * 若不处于动画播放状态，则遍历判定棋盘上的所有棋子，查找第一个可触发消除或爆炸的棋子
  * 若未查找到符合条件的棋子，则本次连续消除结束，更换玩家回合。
  * 若查找到满足条件的棋子，则执行单次消除，或递归爆炸，设置动画标记量，开始绘制动画

* #### 棋子动画播放

  * 动画播放逻辑：在程序中设有一个动画标记变量Anima，该变量记录动画播放的状态，当该量处于0~44的范围内时，说明正处于棋子动画的播放中，绘图过程则会根据棋子结构体中“上一次位置”和棋子本身的位置的差值 与 Anima的当前值计算棋子在移动动画中的位置。每次绘图函数执行结束标记量都会加一，直至标记量等于45时，说明动画绘制结束。

### 玩家血量更新

* 每次执行消除和爆炸操作时，给当前回合玩家的对手扣除对应血量，若某个玩家的血量归零，则立即更改游戏状态变量，游戏结束。

### 双缓冲绘图

​	游戏界面的绘制设计棋子的移动等问题，双缓冲绘图可以保证棋子在更新时不会有瞬移的效果，棋子移动动作中画面不会不断闪烁。

## 难点

* 将动画内嵌在连续消除的过程中，需要将连续消除的过程拆在不连续的帧中分别执行。

